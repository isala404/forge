// Auto-generated by FORGE - DO NOT EDIT

import { createQuery, createMutation } from "@forge/svelte";
import type {
  User,
  CreateUserInput,
  UpdateUserInput,
  DeleteUserInput,
  Job,
  Workflow,
  JobStats,
  WorkflowStats,
} from "./types";

export const getUsers = createQuery<Record<string, never>, User[]>("get_users");
export const getUser = createQuery<{ id: string }, User | null>("get_user");
export const getAppStats = createQuery<
  Record<string, never>,
  Record<string, string>
>("get_app_stats");

export const createUser = createMutation<CreateUserInput, User>("create_user");
export const updateUser = createMutation<UpdateUserInput, User>("update_user");
export const deleteUser = createMutation<DeleteUserInput, boolean>(
  "delete_user",
);

const API_URL = import.meta.env.VITE_API_URL || "http://localhost:8080";

interface ApiResponse<T> {
  success: boolean;
  data?: T;
  error?: string;
}

export async function getJobStatus(jobId: string): Promise<ApiResponse<Job>> {
  const response = await fetch(`${API_URL}/_api/jobs/${jobId}`);
  return response.json();
}

export async function getWorkflowStatus(
  workflowId: string,
): Promise<ApiResponse<Workflow>> {
  const response = await fetch(`${API_URL}/_api/workflows/${workflowId}`);
  return response.json();
}

export async function getJobStats(): Promise<ApiResponse<JobStats>> {
  const response = await fetch(`${API_URL}/_api/jobs/stats`);
  return response.json();
}

export async function getWorkflowStats(): Promise<ApiResponse<WorkflowStats>> {
  const response = await fetch(`${API_URL}/_api/workflows/stats`);
  return response.json();
}

export async function pollJobUntilComplete(
  jobId: string,
  options?: {
    onProgress?: (job: Job) => void;
    pollInterval?: number;
    timeout?: number;
  },
): Promise<Job | null> {
  const { onProgress, pollInterval = 500, timeout = 300000 } = options || {};
  const startTime = Date.now();

  while (Date.now() - startTime < timeout) {
    const { data: job } = await getJobStatus(jobId);
    if (!job) return null;

    onProgress?.(job);

    if (
      job.status === "completed" ||
      job.status === "failed" ||
      job.status === "dead_letter"
    ) {
      return job;
    }

    await new Promise((resolve) => setTimeout(resolve, pollInterval));
  }

  return null;
}

export async function pollWorkflowUntilComplete(
  workflowId: string,
  options?: {
    onStepChange?: (workflow: Workflow) => void;
    pollInterval?: number;
    timeout?: number;
  },
): Promise<Workflow | null> {
  const { onStepChange, pollInterval = 500, timeout = 300000 } = options || {};
  const startTime = Date.now();
  let lastStepsJson = "";

  while (Date.now() - startTime < timeout) {
    const { data: workflow } = await getWorkflowStatus(workflowId);
    if (!workflow) return null;

    const stepsJson = JSON.stringify(
      workflow.steps?.map((s) => ({ name: s.name, status: s.status })) || [],
    );
    if (stepsJson !== lastStepsJson) {
      lastStepsJson = stepsJson;
      onStepChange?.(workflow);
    }

    if (
      workflow.status === "completed" ||
      workflow.status === "failed" ||
      workflow.status === "compensated"
    ) {
      onStepChange?.(workflow);
      return workflow;
    }

    await new Promise((resolve) => setTimeout(resolve, pollInterval));
  }

  return null;
}

export async function dispatchJob<T = Record<string, unknown>>(
  jobType: string,
  args?: T,
): Promise<ApiResponse<{ job_id: string }>> {
  const response = await fetch(`${API_URL}/_api/jobs/${jobType}/dispatch`, {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({ args: args || {} }),
  });
  return response.json();
}

export async function startWorkflow<T = Record<string, unknown>>(
  workflowName: string,
  input?: T,
): Promise<ApiResponse<{ workflow_id: string }>> {
  const response = await fetch(
    `${API_URL}/_api/workflows/${workflowName}/start`,
    {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ input: input || {} }),
    },
  );
  return response.json();
}

import {
  createJobTracker,
  createWorkflowTracker,
  type JobTracker,
  type WorkflowTracker,
} from "@forge/svelte";

export interface ExportUsersJobArgs {
  format: "csv" | "json";
  include_inactive?: boolean;
}

export interface AccountVerificationWorkflowArgs {
  user_id: string;
}

export function createExportUsersJob(): JobTracker<ExportUsersJobArgs> {
  return createJobTracker<ExportUsersJobArgs>("export_users", API_URL);
}

export function createAccountVerificationWorkflow(): WorkflowTracker<AccountVerificationWorkflowArgs> {
  return createWorkflowTracker<AccountVerificationWorkflowArgs>(
    "account_verification",
    API_URL,
  );
}
