use forge::prelude::*;

mod functions;
mod schema;

#[cfg(feature = "embedded-frontend")]
mod embedded {
    use axum::{
        body::Body,
        http::{header, Request, StatusCode},
        response::{IntoResponse, Response},
    };
    use rust_embed::Embed;
    use std::future::Future;
    use std::pin::Pin;

    #[derive(Embed)]
    #[folder = "frontend/build"]
    pub struct Assets;

    async fn serve_frontend_inner(req: Request<Body>) -> Response {
        let path = req.uri().path().trim_start_matches('/');
        let path = if path.is_empty() { "index.html" } else { path };

        match Assets::get(path) {
            Some(content) => {
                let mime = mime_guess::from_path(path).first_or_octet_stream();
                ([(header::CONTENT_TYPE, mime.as_ref())], content.data).into_response()
            }
            None => {
                // SPA fallback - serve index.html for client-side routing
                match Assets::get("index.html") {
                    Some(content) => {
                        ([(header::CONTENT_TYPE, "text/html")], content.data).into_response()
                    }
                    None => (StatusCode::NOT_FOUND, "not found").into_response(),
                }
            }
        }
    }

    pub fn serve_frontend(req: Request<Body>) -> Pin<Box<dyn Future<Output = Response> + Send>> {
        Box::pin(serve_frontend_inner(req))
    }
}

#[tokio::main]
async fn main() -> Result<()> {
    dotenvy::dotenv().ok();
    tracing_subscriber::fmt().with_env_filter("info").init();

    let config = ForgeConfig::from_file("forge.toml")?;
    let mut builder = Forge::builder();

    // Queries
    builder
        .function_registry_mut()
        .register_query::<functions::GetUsersQuery>();
    builder
        .function_registry_mut()
        .register_query::<functions::GetUserQuery>();
    builder
        .function_registry_mut()
        .register_query::<functions::GetAppStatsQuery>();

    // Mutations
    builder
        .function_registry_mut()
        .register_mutation::<functions::CreateUserMutation>();
    builder
        .function_registry_mut()
        .register_mutation::<functions::UpdateUserMutation>();
    builder
        .function_registry_mut()
        .register_mutation::<functions::DeleteUserMutation>();

    // Actions
    builder
        .function_registry_mut()
        .register_action::<functions::GetBitcoinPriceAction>();

    // Jobs
    builder
        .job_registry_mut()
        .register::<functions::ExportUsersJob>();

    // Crons
    builder
        .cron_registry_mut()
        .register::<functions::HeartbeatStatsCron>();

    // Workflows
    builder
        .workflow_registry_mut()
        .register::<functions::AccountVerificationWorkflow>();

    #[cfg(feature = "embedded-frontend")]
    builder.frontend_handler(embedded::serve_frontend);

    builder.config(config).build()?.run().await
}
